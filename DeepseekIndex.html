<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Business & Inventory Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#0f172a 0,#020617 40%,#020617 100%);
      color:#111827;
    }
    a{color:inherit;text-decoration:none}

    /* GENERAL LAYOUT */
    #login-page{
      height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:24px;
    }
    #login-box,#setup-box{max-width:380px;width:100%}

    #app{
      display:none;
      min-height:100vh;
    }
    .layout{
      display:flex;
      min-height:100vh;
    }

    /* SIDEBAR */
    .sidebar{
      width:230px;
      background:linear-gradient(180deg,#020617,#030712);
      color:#e5e7eb;
      padding:16px 12px;
      border-right:1px solid #1f2937;
      position:sticky;
      top:0;
      align-self:flex-start;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .sidebar-logo{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      font-size:15px;
    }
    .sidebar-logo-badge{
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e,#0ea5e9);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:bold;
      color:#0b1120;
      box-shadow:0 0 0 1px rgba(15,23,42,0.4);
    }
    .sidebar-business{
      font-size:11px;
      color:#9ca3af;
    }
    .sidebar-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      margin-top:4px;
      margin-bottom:4px;
    }
    .sidebar-user-mini{
      font-size:11px;
      color:#9ca3af;
      line-height:1.4;
      margin-top:6px;
    }
    .sidebar-tabs{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:4px;
    }

    /* TAB BUTTONS ‚Äì vertical pills */
    .tab-btn{
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      text-align:left;
      transition:background .15s ease,border-color .15s ease,transform .12s ease;
    }
    .tab-btn .tab-icon{
      font-size:14px;
      opacity:.85;
    }
    .tab-btn:hover{
      background:rgba(15,23,42,.9);
      border-color:#1f2937;
      transform:translateX(1px);
    }
    .tab-btn.active{
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      color:#0b1120;
      border-color:transparent;
      box-shadow:0 0 0 1px rgba(15,23,42,0.6);
    }

    /* COLOR ACCENTS PER TAB */
    #tabbtn-dashboard.active{
      background:linear-gradient(90deg,#0ea5e9,#22c55e);
    }
    #tabbtn-items.active{
      background:linear-gradient(90deg,#6366f1,#a855f7);
    }
    #tabbtn-stockin.active{
      background:linear-gradient(90deg,#22c55e,#16a34a);
    }
    #tabbtn-sales.active{
      background:linear-gradient(90deg,#0f766e,#22c55e);
    }
    #tabbtn-summary.active,
    #tabbtn-reorder.active{
      background:linear-gradient(90deg,#a855f7,#6366f1);
    }
    #tabbtn-assets.active{
      background:linear-gradient(90deg,#f59e0b,#f97316);
    }
    #tabbtn-expenses.active{
      background:linear-gradient(90deg,#ef4444,#b91c1c);
    }
    #tabbtn-users.active,
    #tabbtn-settings.active{
      background:linear-gradient(90deg,#6b7280,#4b5563);
    }

    /* CONTENT AREA */
    .content-area{
      flex:1;
      display:flex;
      flex-direction:column;
      background:#f3f4f6;
    }
    header{
      background:#0b1120;
      color:#f9fafb;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid #1f2937;
    }
    header h1{
      font-size:16px;
      font-weight:600;
    }
    header .user-info{
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    main{
      flex:1;
      padding:18px 18px 24px;
    }

    /* BUTTONS */
    button{
      padding:6px 12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
    }
    .btn-primary{
      background:#2563eb;
      color:#fff;
      box-shadow:0 1px 2px rgba(15,23,42,.3);
    }
    .btn-primary:hover{background:#1d4ed8;}
    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
    }
    .btn-danger{
      background:#dc2626;
      color:#fff;
    }

    /* CARDS & STATS */
    .card{
      background:#ffffff;
      border-radius:14px;
      padding:16px 16px 14px;
      margin-bottom:16px;
      box-shadow:
        0 18px 35px rgba(15,23,42,0.06),
        0 2px 4px rgba(15,23,42,0.08);
      border:1px solid #e5e7eb;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
    }
    .stat{
      background:#f9fafb;
      border-radius:12px;
      padding:10px 12px;
      box-shadow:inset 0 0 0 1px #e5e7eb;
    }
    .stat-title{
      font-size:12px;
      color:#6b7280;
      margin-bottom:3px;
    }
    .stat-value{
      font-size:20px;
      font-weight:700;
    }

    /* TYPOGRAPHY & UTILITIES */
    .mt-1{margin-top:4px}
    .mt-2{margin-top:8px}
    .mt-4{margin-top:16px}
    .flex{display:flex;align-items:center;gap:8px}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .text-sm{font-size:13px}
    .text-xs{font-size:12px}
    .text-muted{color:#6b7280}

    label{
      display:block;
      font-size:12px;
      margin-bottom:4px;
      color:#374151;
    }
    input,select,textarea{
      width:100%;
      padding:8px 9px;
      margin-bottom:10px;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:13px;
      background:#f9fafb;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.4);
      background:#ffffff;
    }

    /* TABLES */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:12px;
      background:#fff;
    }
    th,td{
      padding:6px 8px;
      border:1px solid #e5e7eb;
      text-align:left;
    }
    th{
      background:#f9fafb;
      font-weight:600;
      color:#4b5563;
    }
    tr:nth-child(even) td{background:#f9fafb;}
    tr.low-stock{background:#fee2e2;}
    td.status-reorder{color:#b91c1c;font-weight:bold;}

    /* PAGINATION */
    .pagination{
      margin-top:8px;
      font-size:11px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .pagination-left{display:flex;align-items:center;gap:4px}
    .pagination-right{display:flex;align-items:center;gap:4px}
    .page-btn{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#e5e7eb;
      cursor:pointer;
      font-size:11px;
    }
    .page-btn.active{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }
    .page-btn:hover{background:#d1d5db}
    .page-label{font-size:11px;color:#6b7280}

    .bulk-bar{
      margin-top:8px;
      margin-bottom:4px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      font-size:11px;
    }

    /* MONTHLY PERFORMANCE COLORS */
    .month-high{background:#dcfce7;}
    .month-medium{background:#fef9c3;}
    .month-low{background:#fee2e2;}

    /* RESPONSIVE */
    @media(max-width:900px){
      .layout{flex-direction:column;}
      .sidebar{
        position:relative;
        width:100%;
        border-right:none;
        border-bottom:1px solid #1f2937;
        flex-direction:row;
        flex-wrap:wrap;
        align-items:flex-start;
        gap:10px;
      }
      .sidebar-tabs{
        flex-direction:row;
        flex-wrap:wrap;
      }
      .tab-btn{
        flex:1 1 auto;
        justify-content:flex-start;
      }
    }
    @media(max-width:600px){
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:4px;
      }
      main{padding:14px;}
    }
  </style>
</head>
<body>

<!-- LOGIN & FIRST-TIME SETUP -->
<div id="login-page">
  <div class="card" id="setup-box" style="display:none;">
    <h2 style="margin-bottom:12px;">Initial Setup ‚Äì Create Owner/Admin</h2>
    <p class="text-sm text-muted" style="margin-bottom:12px;">
      Hii itaonekana mara ya kwanza tu. Tengeneza akaunti yako ya Owner/Admin.
    </p>
    <form id="setup-form">
      <label for="setup-username">Admin Username</label>
      <input id="setup-username" type="text" required />
      <label for="setup-password">Password</label>
      <input id="setup-password" type="password" required />
      <label for="setup-password2">Repeat Password</label>
      <input id="setup-password2" type="password" required />
      <button type="submit" class="btn-primary" style="width:100%;margin-top:6px;">Create Admin & Login</button>
    </form>
  </div>

  <div class="card" id="login-box">
    <h2 style="margin-bottom:12px;">Login to Business System</h2>
    <form id="login-form">
      <label for="login-username">Username</label>
      <input id="login-username" type="text" required />
      <label for="login-password">Password</label>
      <input id="login-password" type="password" required />
      <button type="submit" class="btn-primary" style="width:100%;margin-top:6px;">Login</button>
    </form>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  <div class="layout">
    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-logo">
          <div class="sidebar-logo-badge">B</div>
          <div>
            <div>Business Manager</div>
            <div class="sidebar-business" id="sidebar-business-name">Your Business</div>
          </div>
        </div>
        <div class="sidebar-user-mini">
          Logged in as: <span id="sidebar-user-name">‚Äî</span><br>
          Role: <span id="sidebar-user-role">‚Äî</span>
        </div>
      </div>

      <div>
        <div class="sidebar-section-title">Navigation</div>
        <div class="sidebar-tabs">
          <button class="tab-btn active" data-tab="dashboard" id="tabbtn-dashboard">
            <span class="tab-icon">üìä</span><span>Dashboard</span>
          </button>
          <button class="tab-btn" data-tab="items" id="tabbtn-items">
            <span class="tab-icon">üì¶</span><span>Master List</span>
          </button>
          <button class="tab-btn" data-tab="stockin" id="tabbtn-stockin">
            <span class="tab-icon">üì•</span><span>Stock In</span>
          </button>
          <button class="tab-btn" data-tab="sales" id="tabbtn-sales">
            <span class="tab-icon">üí∞</span><span>Sales</span>
          </button>
          <button class="tab-btn" data-tab="summary" id="tabbtn-summary">
            <span class="tab-icon">üìä</span><span>Stock Summary</span>
          </button>
          <button class="tab-btn" data-tab="reorder" id="tabbtn-reorder">
            <span class="tab-icon">üîÅ</span><span>Re-order</span>
          </button>
          <button class="tab-btn" data-tab="assets" id="tabbtn-assets">
            <span class="tab-icon">üè∑Ô∏è</span><span>Assets</span>
          </button>
          <button class="tab-btn" data-tab="expenses" id="tabbtn-expenses">
            <span class="tab-icon">üìâ</span><span>Expenses</span>
          </button>
          <button class="tab-btn" data-tab="users" id="tabbtn-users">
            <span class="tab-icon">üë•</span><span>Users</span>
          </button>
          <button class="tab-btn" data-tab="settings" id="tabbtn-settings">
            <span class="tab-icon">‚öôÔ∏è</span><span>Settings</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- RIGHT SIDE: HEADER + CONTENT -->
    <div class="content-area">
      <header>
        <h1 id="header-title">Inventory &amp; Business Management</h1>
        <div class="user-info">
          Logged in as: <span id="current-username"></span>
          (<span id="current-role"></span>)
          <button id="logout-btn" class="btn-secondary">Logout</button>
        </div>
      </header>

      <main>
        <!-- DASHBOARD -->
        <section id="tab-dashboard" class="tab-page" style="display:block;">
          <!-- QUICK SALES OVERVIEW -->
          <div class="card">
            <h3>Quick Sales Overview</h3>
            <p class="text-xs text-muted mt-1">
              Total Sales based on common periods using your current data.
            </p>
            <div class="grid mt-2">
              <div class="stat">
                <div class="stat-title">Today</div>
                <div class="stat-value" id="qsales-today">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">This Week</div>
                <div class="stat-value" id="qsales-week">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">This Month</div>
                <div class="stat-value" id="qsales-month">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">This Year</div>
                <div class="stat-value" id="qsales-year">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Lifetime</div>
                <div class="stat-value" id="qsales-lifetime">0</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Business Performance (Selected Period)</h3>
            <div class="grid mt-2">
              <div>
                <label>Start Date</label>
                <input type="date" id="dash-start" />
              </div>
              <div>
                <label>End Date</label>
                <input type="date" id="dash-end" />
              </div>
              <div style="display:flex;align-items:flex-end;">
                <button id="dash-apply" class="btn-primary">Apply</button>
              </div>
            </div>
            <div class="grid mt-2">
              <div class="stat">
                <div class="stat-title">Total Sales</div>
                <div class="stat-value" id="dash-period-sales">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Capital Used (Buying Cost)</div>
                <div class="stat-value" id="dash-period-capital">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Gross Profit (Sales - Capital)</div>
                <div class="stat-value" id="dash-period-gross">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Total Expenses</div>
                <div class="stat-value" id="dash-period-expenses">0</div>
              </div>
              <div class="stat">
                <div class="stat-title">Net Profit</div>
                <div class="stat-value" id="dash-period-net">0</div>
              </div>
            </div>

            <div class="mt-4">
              <h4 class="text-sm">Expense Breakdown (Selected Period)</h4>
              <p class="text-xs text-muted">
                Inaonesha jinsi gharama zinavyogawanywa: Asset Depreciation, kila Fixed Expense, na Minor Expenses.
              </p>
              <table class="mt-1">
                <thead>
                  <tr><th>Expense</th><th>Amount</th></tr>
                </thead>
                <tbody id="dash-expenses-breakdown-body"></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="flex-between">
              <h3>Monthly Performance ‚Äì Year</h3>
              <div class="flex">
                <input type="number" id="dash-year" style="width:100px;" />
                <button id="dash-year-apply" class="btn-secondary">Update</button>
              </div>
            </div>
            <table class="mt-2">
              <thead>
                <tr>
                  <th>Month</th><th>Total Sales</th><th>Capital Used</th><th>Total Expenses</th><th>Net Profit</th>
                </tr>
              </thead>
              <tbody id="dash-monthly-body"></tbody>
            </table>
            <p class="text-xs text-muted mt-1">
              Green = High performance, Yellow = Moderate, Red = Poor / Loss.
            </p>
          </div>

          <div class="card">
            <h3>Top Products (Selected Period)</h3>
            <div class="grid mt-2">
              <div>
                <h4 class="text-sm">Top 5 High Performing (by Profit)</h4>
                <table class="mt-2">
                  <thead>
                    <tr><th>Item</th><th>Qty</th><th>Sales</th><th>Profit</th></tr>
                  </thead>
                  <tbody id="top-best-body"></tbody>
                </table>
              </div>
              <div>
                <h4 class="text-sm">Top 5 Poor Performing (by Profit)</h4>
                <table class="mt-2">
                  <thead>
                    <tr><th>Item</th><th>Qty</th><th>Sales</th><th>Profit</th></tr>
                  </thead>
                  <tbody id="top-worst-body"></tbody>
                </table>
              </div>
              <div>
                <h4 class="text-sm">Top 5 Dead Products (Not Sold in Period)</h4>
                <table class="mt-2">
                  <thead>
                    <tr><th>Item</th><th>Stock Balance</th></tr>
                  </thead>
                  <tbody id="top-dead-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- MASTER LIST -->
        <section id="tab-items" class="tab-page">
          <div class="card">
            <div class="flex-between">
              <h3>Master List (Items)</h3>
              <span class="text-xs text-muted">Item Name, Category, Unit only</span>
            </div>
            <form id="item-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Item Name</label>
                  <input id="item-name" required />
                </div>
                <div>
                  <label>Category</label>
                  <input id="item-category" placeholder="e.g. Body Lotion, Soap" />
                </div>
                <div>
                  <label>Unit</label>
                  <input id="item-unit" placeholder="PCS, BTL, BOX" />
                </div>
                <div style="display:flex;align-items:flex-end;">
                  <button type="submit" class="btn-primary">Add Item</button>
                </div>
              </div>
            </form>

            <div class="mt-2">
              <label>Upload Master List (CSV/TXT: Item Name, Category, Unit)</label>
              <input type="file" id="item-upload" accept=".csv,.txt" />
            </div>

            <div class="bulk-bar">
              <label><input type="checkbox" id="items-select-all" /> Select All</label>
              <button class="btn-danger" id="items-bulk-delete">Delete Selected</button>
            </div>

            <table class="mt-1" id="items-table">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Item Name</th><th>Category</th><th>Unit</th><th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="pagination" id="items-pagination"></div>
          </div>
        </section>

        <!-- STOCK IN -->
        <section id="tab-stockin" class="tab-page">
          <div class="card">
            <h3>Stock In (Manunuzi)</h3>
            <form id="stockin-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Search Item</label>
                  <input type="text" id="stockin-item-search" placeholder="Type to search item..." />
                </div>
                <div>
                  <label>Item</label>
                  <select id="stockin-item" required></select>
                </div>
                <div>
                  <label>Quantity</label>
                  <input id="stockin-qty" type="number" min="1" required />
                </div>
                <div>
                  <label>Buying Price (per unit)</label>
                  <input id="stockin-buy" type="number" min="0" step="0.01" required />
                </div>
                <div>
                  <label>Date</label>
                  <input id="stockin-date" type="date" required />
                </div>
                <div style="display:flex;align-items:flex-end;gap:6px;">
                  <button type="submit" class="btn-primary" id="stockin-submit-btn">Add Stock</button>
                  <button type="button" class="btn-secondary" id="stockin-cancel-edit" style="display:none;">Cancel Edit</button>
                </div>
              </div>
            </form>

            <div class="mt-2">
              <label>Upload Stock In (CSV/TXT: Date, Item, Qty, Buying Price)</label>
              <input type="file" id="stockin-upload" accept=".csv,.txt" />
            </div>

            <div class="bulk-bar">
              <label><input type="checkbox" id="stockin-select-all" /> Select All</label>
              <button class="btn-danger" id="stockin-bulk-delete">Delete Selected</button>
              <div class="flex">
                <span class="text-xs">Change Date for selected:</span>
                <input type="date" id="stockin-bulk-date" style="width:140px;" />
                <button class="btn-secondary" id="stockin-bulk-change-date">Apply</button>
              </div>
            </div>

            <table class="mt-1" id="stockin-table">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Date</th><th>Item</th><th>Qty</th><th>Buy Price</th><th>Total</th><th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="pagination" id="stockin-pagination"></div>
          </div>
        </section>

        <!-- SALES -->
        <section id="tab-sales" class="tab-page">
          <div class="card">
            <h3>Sales (Mauzo)</h3>
            <div class="grid mt-2">
              <div class="stat">
                <div class="stat-title">Today's Total Sales</div>
                <div class="stat-value" id="sales-today-total">0</div>
              </div>
            </div>
            <form id="sales-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Search Item (available stock only)</label>
                  <input type="text" id="sales-item-search" placeholder="Type to search item..." />
                </div>
                <div>
                  <label>Item</label>
                  <select id="sales-item" required></select>
                </div>
                <div>
                  <label>Quantity</label>
                  <input id="sales-qty" type="number" min="1" required />
                </div>
                <div>
                  <label>Selling Price (per unit)</label>
                  <input id="sales-price" type="number" min="0" step="0.01" required />
                </div>
                <div>
                  <label>Date</label>
                  <input id="sales-date" type="date" required />
                </div>
                <div style="display:flex;align-items:flex-end;gap:6px;">
                  <button type="submit" class="btn-primary" id="sales-submit-btn">Add Sale</button>
                  <button type="button" class="btn-secondary" id="sales-cancel-edit" style="display:none;">Cancel Edit</button>
                </div>
              </div>
            </form>

            <div class="mt-2">
              <label>Upload Sales (CSV/TXT: Date, Item, Qty, Selling Price)</label>
              <input type="file" id="sales-upload" accept=".csv,.txt" />
            </div>

            <div class="bulk-bar">
              <label><input type="checkbox" id="sales-select-all" /> Select All</label>
              <button class="btn-danger" id="sales-bulk-delete">Delete Selected</button>
              <div class="flex">
                <span class="text-xs">Change Date for selected:</span>
                <input type="date" id="sales-bulk-date" style="width:140px;" />
                <button class="btn-secondary" id="sales-bulk-change-date">Apply</button>
              </div>
            </div>

            <table class="mt-1" id="sales-table">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Date</th><th>Item</th><th>Qty</th><th>Sell Price</th><th>Total</th><th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="pagination" id="sales-pagination"></div>
          </div>
        </section>

        <!-- STOCK SUMMARY -->
        <section id="tab-summary" class="tab-page">
          <div class="card">
            <div class="flex-between">
              <h3>Stock Summary</h3>
              <div class="flex">
                <label class="text-xs text-muted">Margin % for RE-ORDER:&nbsp;</label>
                <input type="number" id="summary-margin" style="width:80px;" min="0" max="100" />
                <button id="btn-save-margin" class="btn-secondary" style="margin-left:6px;">Save</button>
              </div>
            </div>
            <table class="mt-2" id="summary-table">
              <thead>
                <tr>
                  <th>#</th><th>Item</th><th>Category</th><th>Unit</th><th>In Qty</th><th>Out Qty</th><th>Balance</th><th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="pagination" id="summary-pagination"></div>
          </div>
        </section>

        <!-- RE-ORDER -->
        <section id="tab-reorder" class="tab-page">
          <div class="card">
            <h3>Re-order List (Current RE-ORDER Items)</h3>
            <div class="bulk-bar">
              <label><input type="checkbox" id="reorder-select-all" /> Select All</label>
              <button class="btn-secondary" id="reorder-bulk-hide">Hide Selected (Not Planned)</button>
            </div>
            <table class="mt-1">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Item</th><th>Category</th><th>Unit</th><th>In Qty</th><th>Out Qty</th><th>Balance</th><th>Status</th>
                </tr>
              </thead>
              <tbody id="reorder-table-body"></tbody>
            </table>
            <div class="pagination" id="reorder-pagination"></div>
          </div>

          <div class="card">
            <div class="flex-between">
              <h3>Hidden Re-order Items</h3>
              <button class="btn-secondary" id="reorder-toggle-hidden">Show / Hide</button>
            </div>
            <div id="reorder-hidden-wrapper" style="margin-top:8px;display:none;">
              <div class="bulk-bar">
                <label><input type="checkbox" id="reorder-hidden-select-all" /> Select All</label>
                <button class="btn-secondary" id="reorder-hidden-bulk-unhide">Unhide Selected</button>
              </div>
              <table class="mt-1">
                <thead>
                  <tr>
                    <th></th><th>#</th><th>Item</th><th>Category</th><th>Unit</th><th>Balance</th>
                  </tr>
                </thead>
                <tbody id="reorder-hidden-table-body"></tbody>
              </table>
              <div class="pagination" id="reorder-hidden-pagination"></div>
            </div>
          </div>
        </section>

        <!-- ASSETS -->
        <section id="tab-assets" class="tab-page">
          <div class="card">
            <h3>Assets (for Depreciation)</h3>
            <form id="asset-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Asset Name</label>
                  <input id="asset-name" required />
                </div>
                <div>
                  <label>Category</label>
                  <input id="asset-category" placeholder="e.g. Shelves, Furniture" />
                </div>
                <div>
                  <label>Purchase Date</label>
                  <input id="asset-date" type="date" />
                </div>
                <div>
                  <label>Cost</label>
                  <input id="asset-cost" type="number" min="0" step="0.01" required />
                </div>
                <div>
                  <label>Useful Life (years)</label>
                  <input id="asset-years" type="number" min="1" step="1" required />
                </div>
                <div style="display:flex;align-items:flex-end;gap:6px;">
                  <button type="submit" class="btn-primary" id="asset-submit-btn">Add Asset</button>
                  <button type="button" class="btn-secondary" id="asset-cancel-edit" style="display:none;">Cancel Edit</button>
                </div>
              </div>
            </form>

            <div class="mt-2">
              <label>Upload Assets (CSV/TXT: Asset Name, Category, Cost, Years, Purchase Date)</label>
              <input type="file" id="assets-upload" accept=".csv,.txt" />
            </div>

            <p class="text-sm text-muted mt-2">
              Daily Depreciation per asset = Cost / (Years √ó 365)
            </p>
            <p class="mt-2"><b>Total Daily Depreciation (active assets today):</b> <span id="assets-daily-total">0</span></p>
            <p class="mt-1"><b>Total Net Book Value (All Assets):</b> <span id="assets-nbv-total">0</span></p>

            <div class="bulk-bar">
              <label><input type="checkbox" id="assets-select-all" /> Select All</label>
              <button class="btn-danger" id="assets-bulk-delete">Delete Selected</button>
            </div>

            <table class="mt-2">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Asset</th><th>Category</th><th>Cost</th><th>Years</th><th>Daily Depreciation</th><th>Net Book Value (Today)</th><th>Purchase Date</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="assets-table-body"></tbody>
            </table>
            <div class="pagination" id="assets-pagination"></div>
          </div>
        </section>

        <!-- EXPENSES -->
        <section id="tab-expenses" class="tab-page">
          <!-- FIXED EXPENSES CARD (Owner/Admin only) -->
          <div class="card" id="fixed-expenses-card">
            <h3>Fixed Expenses (Office Running Costs)</h3>
            <p class="text-xs text-muted mt-1">
              Add fixed expenses like Rent, Salary, Transport. System converts to daily cost automatically and respects Effective From / Until.
            </p>

            <form id="fixedexp-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Expense Name</label>
                  <input id="fixedexp-name" required />
                </div>
                <div>
                  <label>Frequency</label>
                  <select id="fixedexp-frequency">
                    <option value="daily">Daily</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
                <div>
                  <label>Amount (per selected frequency)</label>
                  <input id="fixedexp-amount" type="number" min="0" step="0.01" required />
                </div>
                <div>
                  <label>Effective From</label>
                  <input id="fixedexp-from" type="date" />
                </div>
                <div>
                  <label>Until</label>
                  <input id="fixedexp-to" type="date" />
                </div>
                <div style="display:flex;align-items:flex-end;gap:6px;">
                  <button type="submit" class="btn-primary" id="fixedexp-submit-btn">Add Fixed Expense</button>
                  <button type="button" class="btn-secondary" id="fixedexp-cancel-edit" style="display:none;">Cancel Edit</button>
                </div>
              </div>
            </form>

            <div class="bulk-bar">
              <label><input type="checkbox" id="fixedexp-select-all" /> Select All</label>
              <button class="btn-danger" id="fixedexp-bulk-delete">Delete Selected</button>
            </div>

            <table class="mt-1">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Name</th><th>Frequency</th><th>Amount</th><th>Daily Cost</th><th>Effective From</th><th>Until</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="fixedexp-table-body"></tbody>
            </table>
            <div class="pagination" id="fixedexp-pagination"></div>

            <p class="mt-2"><b>Total Daily Fixed Expenses (excluding depreciation, active today):</b> <span id="fixedexp-daily-total">0</span></p>
            <p class="mt-1"><b>Total Daily Asset Depreciation (active today):</b> <span id="exp-daily-dep">0</span></p>
            <p class="mt-1"><b>Total Daily Fixed Operation Cost:</b> <span id="exp-daily-operation">0</span></p>
          </div>

          <!-- MINOR EXPENSES CARD (all roles can use, Staff included) -->
          <div class="card" id="minor-expenses-card">
            <h3>Minor / Non-Fixed Expenses</h3>
            <p class="text-xs text-muted">Staff, Manager/Editor & Owner/Admin can add/edit/delete minor expenses.</p>
            <form id="minexp-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Date</label>
                  <input type="date" id="minexp-date" required />
                </div>
                <div>
                  <label>Category</label>
                  <input id="minexp-category" />
                </div>
                <div>
                  <label>Description</label>
                  <input id="minexp-desc" />
                </div>
                <div>
                  <label>Amount</label>
                  <input id="minexp-amount" type="number" min="0" step="0.01" required />
                </div>
                <div style="display:flex;align-items:flex-end;gap:6px;">
                  <button type="submit" class="btn-primary" id="minexp-submit-btn">Add Expense</button>
                  <button type="button" class="btn-secondary" id="minexp-cancel-edit" style="display:none;">Cancel Edit</button>
                </div>
              </div>
            </form>

            <div class="bulk-bar">
              <label><input type="checkbox" id="minexp-select-all" /> Select All</label>
              <button class="btn-danger" id="minexp-bulk-delete">Delete Selected</button>
            </div>

            <table class="mt-1">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="minexp-table-body"></tbody>
            </table>
            <div class="pagination" id="minexp-pagination"></div>
          </div>
        </section>

        <!-- USERS -->
        <section id="tab-users" class="tab-page">
          <div class="card">
            <h3>Users & Roles</h3>
            <p class="text-sm text-muted">
              Roles:<br>
              - <b>Admin</b> (Owner) ‚Äì full access to everything<br>
              - <b>Editor</b> (Manager) ‚Äì no Dashboard, Assets, Users, Settings, Fixed Expenses<br>
              - <b>Staff</b> ‚Äì Sales + Minor Expenses only
            </p>
            <form id="user-form" class="mt-2">
              <div class="grid">
                <div>
                  <label>Username</label>
                  <input id="user-username" required />
                </div>
                <div>
                  <label>Password</label>
                  <input id="user-password" type="password" required />
                </div>
                <div>
                  <label>Role</label>
                  <select id="user-role"></select>
                </div>
                <div style="display:flex;align-items:flex-end;">
                  <button type="submit" class="btn-primary">Add User</button>
                </div>
              </div>
            </form>

            <div class="bulk-bar">
              <label><input type="checkbox" id="users-select-all" /> Select All</label>
              <button class="btn-danger" id="users-bulk-delete">Delete Selected</button>
            </div>

            <table class="mt-1" id="users-table">
              <thead>
                <tr>
                  <th></th><th>#</th><th>Username</th><th>Role</th><th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="pagination" id="users-pagination"></div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="tab-settings" class="tab-page">
          <div class="card">
            <h3>Settings</h3>
            <p class="text-sm text-muted">Business info & backup tools (Owner/Admin only).</p>

            <div class="grid mt-2">
              <div>
                <label>Business Name</label>
                <input id="cfg-business-name" placeholder="e.g. Somanga Cosmetics" />
              </div>
              <div>
                <label>Currency Label</label>
                <input id="cfg-currency" placeholder="e.g. TSh" />
              </div>
              <div>
                <label>Business Start Date</label>
                <input id="cfg-start-date" type="date" />
              </div>
            </div>
            <p class="text-xs text-muted mt-1">
              All performance calculations ignore data before the business start date.
            </p>

            <button id="btn-save-settings" class="btn-primary" style="margin-top:8px;">Save Settings</button>

            <hr style="margin:16px 0;border:none;border-top:1px solid #e5e7eb;" />

            <p class="text-sm text-muted">Export backup or clear business data.</p>
            <div class="mt-2">
              <button id="btn-export" class="btn-secondary">Export Data (JSON)</button>
              <button id="btn-clear" class="btn-danger" style="margin-left:8px;">Clear Business Data</button>
            </div>
            <textarea id="export-area" class="mt-4" style="width:100%;height:120px;font-size:12px;"></textarea>
          </div>
        </section>
      </main>
    </div>
  </div>
</div>

<script>
  // URL of your deployed Apps Script web app
  const API_URL = 'https://script.google.com/macros/s/AKfycbyKeuhinn3AQeifWzUy7AE-F2XmdN0CWOK7QEiGWvyGxdmY7QdWResn1vtfnmacmR71rQ/exec';

  // STORAGE_KEY is no longer used (we keep it just in case you want local backup later)
  const STORAGE_KEY = 'biz_inventory_data_real_v4_unused';
  const SESSION_USER_KEY = 'biz_inventory_current_user';   // <‚Äî NEW: remember logged-in user
  const PAGE_SIZE = 50;

  let db = {
    items: [],
    stockIns: [],
    sales: [],
    users: [],
    assets: [],
    minorExpenses: [],
    fixedExpenses: [],
    config: {
      businessName: 'My Business',
      currency: 'TSh',
      marginPercent: 20,
      hiddenReorderIds: [],
      businessStartDate: ''
    }
  };
  let currentUser = null;
  let editingStockInId = null;
  let editingSalesId = null;
  let editingMinorExpId = null;
  let editingAssetId = null;
  let editingFixedExpId = null;

  let itemsPage = 1, stockInPage = 1, salesPage = 1, summaryPage = 1, assetsPage = 1, fixedExpPage = 1, minExpPage = 1, usersPage = 1, reorderPage = 1, reorderHiddenPage = 1;

  // Load DB from Google Apps Script (Google Sheet backend)
  async function loadDB() {
    try {
      const res = await fetch(API_URL + '?action=getDb', { method: 'GET' });
      if (!res.ok) {
        console.error('Failed to load DB from server. HTTP', res.status);
        return;
      }

      const data = await res.json();
      const remote = (data && data.db) ? data.db : {};

      db.items         = Array.isArray(remote.items)         ? remote.items         : [];
      db.stockIns      = Array.isArray(remote.stockIns)      ? remote.stockIns      : [];
      db.sales         = Array.isArray(remote.sales)         ? remote.sales         : [];
      db.users         = Array.isArray(remote.users)         ? remote.users         : db.users;
      db.assets        = Array.isArray(remote.assets)        ? remote.assets        : [];
      db.minorExpenses = Array.isArray(remote.minorExpenses) ? remote.minorExpenses : [];
      db.fixedExpenses = Array.isArray(remote.fixedExpenses) ? remote.fixedExpenses : [];
      db.config        = Object.assign({}, db.config, remote.config || {});
      if (!Array.isArray(db.config.hiddenReorderIds)) db.config.hiddenReorderIds = [];
    } catch (e) {
      console.error('Error loading DB from server', e);
    }
  }

  // Save DB to Google Apps Script (Google Sheets backend) ‚Äì CORS-safe
  function saveDB() {
    try {
      fetch(API_URL, {
        method: 'POST',
        // no headers => no CORS preflight issues
        body: JSON.stringify({
          action: 'saveDb',
          db: db
        })
      })
      .then(res => {
        if (!res.ok) {
          console.error('Failed to save DB. HTTP', res.status);
        }
      })
      .catch(err => {
        console.error('Network error while saving DB', err);
      });
    } catch (e) {
      console.error('Error saving DB to server', e);
    }
  }

  // ... rest of your existing JavaScript code remains the same ...

  // ===== INITIALIZE APP AFTER PAGE LOAD =====
  (async () => {
    // 1. Load DB from Google Sheets
    await loadDB();

    // 2. Try to read saved username from this device
    const savedUsername = sessionStorage.getItem(SESSION_USER_KEY);
    let user = null;

    if (savedUsername) {
      user = (db.users || []).find(u => u.username === savedUsername);
      if (!user) {
        // user was deleted from DB ‚Üí clear session
        sessionStorage.removeItem(SESSION_USER_KEY);
      }
    }

    // 3. If a valid user found ‚Üí auto-login
    if (user) {
      currentUser = user;
      currentUsernameSpan.textContent = user.username;
      currentRoleSpan.textContent = user.role;
      updateSidebarUser();
      loginPage.style.display = 'none';
      app.style.display = 'block';
      initDates();
      applyConfigToUI();
      refreshAll();
      updateUIByRole();
      applyDashboardFilters();
    } else {
      // otherwise show setup/login normally
      showSetupOrLogin();
    }
  })();
</script>
</body>
</html>